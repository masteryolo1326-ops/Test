<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Votación de prueba · Supabase</title>
<!-- 
===========================
  SQL (ejecutar 1 sola vez)
===========================

-- Extensión
create extension if not exists "uuid-ossp";

-- Encuestas
create table if not exists public.polls (
  id uuid primary key default uuid_generate_v4(),
  title text not null,
  created_at timestamptz not null default now(),
  is_active boolean not null default true
);

-- Candidatos
create table if not exists public.candidates (
  id uuid primary key default uuid_generate_v4(),
  poll_id uuid not null references public.polls(id) on delete cascade,
  name text not null,
  info text,
  created_at timestamptz not null default now()
);

-- Votos (1 por usuario por poll; actualizable)
create table if not exists public.votes (
  id uuid primary key default uuid_generate_v4(),
  poll_id uuid not null references public.polls(id) on delete cascade,
  candidate_id uuid not null references public.candidates(id) on delete cascade,
  user_id uuid not null references auth.users(id) on delete cascade,
  created_at timestamptz not null default now(),
  unique (poll_id, user_id)
);

-- Activar RLS
alter table public.polls enable row level security;
alter table public.candidates enable row level security;
alter table public.votes enable row level security;

-- Políticas mínimas
create policy "read polls" on public.polls for select using (true);
create policy "read candidates" on public.candidates for select using (true);
create policy "read votes" on public.votes for select using (true);

create policy "insert polls" on public.polls
  for insert with check (auth.role() = 'authenticated');
create policy "insert candidates" on public.candidates
  for insert with check (auth.role() = 'authenticated');

create policy "insert votes" on public.votes
  for insert with check (auth.uid() = user_id);
create policy "update votes" on public.votes
  for update using (auth.uid() = user_id) with check (auth.uid() = user_id);
-->

<style>
  :root {
    --bg: #0b0f14;
    --card: #121821;
    --muted: #a7b0be;
    --text: #e8edf5;
    --accent: #7c8cff;
    --accent-2: #29d3a0;
    --danger: #ff6b6b;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; font-family: system-ui, Roboto, Inter, Segoe UI, sans-serif;
    background: radial-gradient(1200px 600px at 20% -10%, #142037 0%, transparent 40%),
                radial-gradient(900px 500px at 120% 10%, #0f1a2a 0%, transparent 30%),
                var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: grid;
    place-items: start center;
    padding: 32px 16px 80px;
  }
  .app { width: 100%; max-width: 980px; display: grid; gap: 16px; }
  .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 14px;
    padding: 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    backdrop-filter: blur(8px);
  }
  h1, h2, h3 { margin: 0 0 10px; }
  h1 { font-size: 24px; letter-spacing: 0.2px; }
  p { margin: 6px 0 0; color: var(--muted); }
  .row { display: flex; gap: 10px; flex-wrap: wrap; }
  input, button, select {
    padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12);
    background: #0e1420; color: var(--text); outline: none;
  }
  input::placeholder { color: #7a8596; }
  button {
    cursor: pointer; border: 1px solid rgba(124,140,255,0.35);
    background: linear-gradient(180deg, rgba(124,140,255,0.25), rgba(124,140,255,0.15));
    transition: transform .08s ease, filter .08s ease, box-shadow .2s ease;
  }
  button:hover { transform: translateY(-1px); filter: brightness(1.05); }
  button:active { transform: translateY(0); }
  .ghost { background: transparent; border-color: rgba(255,255,255,0.15); }
  .success { border-color: rgba(41,211,160,0.45);
             background: linear-gradient(180deg, rgba(41,211,160,0.25), rgba(41,211,160,0.12)); }

  .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
  @media (min-width: 860px) { .grid { grid-template-columns: 1.1fr 0.9fr; } }
  .pill {
    display: inline-flex; gap: 8px; align-items: center;
    padding: 6px 10px; border-radius: 999px; font-size: 12px;
    border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.06);
  }
  .list { display: grid; gap: 8px; }
  .candidate {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px; border-radius: 10px; border: 1px dashed rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.03);
  }
  .meter { height: 9px; border-radius: 999px; background: rgba(255,255,255,0.08); overflow: hidden; }
  .meter > div { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); width: 0%; }
  .muted { color: var(--muted); font-size: 13px; }
  .sep { height: 1px; background: rgba(255,255,255,0.08); margin: 12px 0; }
  footer { text-align: center; opacity: .8; font-size: 12px; margin-top: 8px;}
  code.inline { padding: 2px 6px; background: rgba(255,255,255,0.08); border-radius: 6px; }
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div>
        <h1>Votación de prueba</h1>
        <p>Regístrate / inicia sesión, elige una opción y tu voto quedará guardado en Supabase.</p>
      </div>
      <div id="authStatus" class="pill">Desconectado</div>
    </div>
  </div>

  <div class="grid">
    <!-- PANEL DE AUTENTICACIÓN -->
    <div class="card" id="authCard">
      <h2>Acceso</h2>
      <p class="muted">Usa email y contraseña (modo demo).</p>
      <div class="sep"></div>
      <form id="signupForm" class="row" autocomplete="off">
        <input id="su_email" type="email" placeholder="Email" required />
        <input id="su_pass" type="password" placeholder="Contraseña (mín. 6)" minlength="6" required />
        <button type="submit">Crear cuenta</button>
      </form>
      <div class="sep"></div>
      <form id="loginForm" class="row" autocomplete="off">
        <input id="li_email" type="email" placeholder="Email" required />
        <input id="li_pass" type="password" placeholder="Contraseña" required />
        <button type="submit" class="success">Iniciar sesión</button>
        <button type="button" id="logoutBtn" class="ghost">Cerrar sesión</button>
      </form>
      <p id="authMsg" class="muted"></p>
    </div>

    <!-- PANEL DE VOTACIÓN -->
    <div class="card" id="voteCard">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h2 id="pollTitle">Encuesta</h2>
        <span id="myVotePill" class="pill" style="display:none;">Mi voto: <strong id="myVoteName"></strong></span>
      </div>
      <p class="muted">Puedes cambiar tu voto en cualquier momento.</p>
      <div class="sep"></div>

      <div id="candidatesList" class="list"></div>

      <div class="sep"></div>
      <div class="row">
        <button id="refreshBtn" class="ghost">Actualizar</button>
        <button id="seedBtn" title="Crea encuesta y candidatos si faltan">Sembrar datos (si faltan)</button>
      </div>
      <p id="voteMsg" class="muted"></p>
    </div>
  </div>

  <footer>
    Supabase client demo · Realtime on <code class="inline">public.votes</code> · RLS seguro
  </footer>
</div>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script type="module">
/* ==========
   CONFIG YA INTEGRADA
   ========== */
const SUPABASE_URL = "https://amtcdnaenohempvuwjfz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtdGNkbmFlbm9oZW1wdnV3amZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MTI4ODAsImV4cCI6MjA3MjA4ODg4MH0.u32A7Jd2MjNsrWaW9ENtjfu0tjXkonosHNpYYFhucs4";

/* ==========
   APP STATE
   ========== */
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let session = null;
let currentUser = null;
let currentPoll = null;
let candidates = [];
let myVote = null;

/* Utilidades UI */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const setText = (sel, text) => { const el = $(sel); if (el) el.textContent = text; };
const setAuthStatus = (txt) => { $("#authStatus").textContent = txt; };

function toast(el, msg, isError=false) {
  el.textContent = msg;
  el.style.color = isError ? "var(--danger)" : "var(--muted)";
}

/* ==========
   AUTH
   ========== */
async function loadSession() {
  const { data: { session: s } } = await supabase.auth.getSession();
  session = s;
  currentUser = s?.user ?? null;
  setAuthStatus(currentUser ? `Conectado: ${currentUser.email}` : "Desconectado");
  if (currentUser) {
    $("#logoutBtn").disabled = false;
    await ensurePollAndCandidates();
    await loadVoteAndResults();
    subscribeRealtime();
  } else {
    $("#logoutBtn").disabled = true;
  }
}

supabase.auth.onAuthStateChange(async (_event, s) => {
  session = s;
  currentUser = s?.user ?? null;
  setAuthStatus(currentUser ? `Conectado: ${currentUser.email}` : "Desconectado");
  if (currentUser) {
    await ensurePollAndCandidates();
    await loadVoteAndResults();
    subscribeRealtime();
  } else {
    clearUI();
  }
});

$("#signupForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = $("#su_email").value.trim();
  const password = $("#su_pass").value;
  const { error } = await supabase.auth.signUp({ email, password });
  toast($("#authMsg"), error ? `Error: ${error.message}` : "Cuenta creada. Revisa tu correo si te pide confirmación.");
});

$("#loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = $("#li_email").value.trim();
  const password = $("#li_pass").value;
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  toast($("#authMsg"), error ? `Error: ${error.message}` : "Sesión iniciada.");
});

$("#logoutBtn").addEventListener("click", async () => {
  await supabase.auth.signOut();
  toast($("#authMsg"), "Sesión cerrada.");
});

/* ==========
   DATA: Poll & Candidates
   ========== */
async function ensurePollAndCandidates() {
  // 1) obtener (o crear) la poll "Votación de prueba"
  let { data: polls, error: ep } = await supabase
    .from("polls")
    .select("*")
    .eq("title", "Votación de prueba")
    .limit(1);

  if (ep) { toast($("#voteMsg"), "Error cargando encuesta: " + ep.message, true); return; }

  if (!polls || polls.length === 0) {
    // intentar crear (requiere política insert)
    const { data: created, error: ei } = await supabase
      .from("polls")
      .insert({ title: "Votación de prueba", is_active: true })
      .select()
      .limit(1);
    if (ei) {
      toast($("#voteMsg"), "No existe encuesta y no se pudo crear (revisa políticas RLS).", true);
      return;
    }
    currentPoll = created[0];
  } else {
    currentPoll = polls[0];
  }

  setText("#pollTitle", currentPoll?.title ?? "Encuesta");
  // 2) candidatos
  const { data: cands, error: ec } = await supabase
    .from("candidates")
    .select("*")
    .eq("poll_id", currentPoll.id)
    .order("created_at", { ascending: true });

  if (ec) { toast($("#voteMsg"), "Error cargando candidatos: " + ec.message, true); return; }

  let localCands = cands ?? [];

  // si no hay candidatos, sembrar 3 por defecto
  if (localCands.length === 0) {
    const seed = [
      { poll_id: currentPoll.id, name: "Opción A", info: "Descripción A" },
      { poll_id: currentPoll.id, name: "Opción B", info: "Descripción B" },
      { poll_id: currentPoll.id, name: "Opción C", info: "Descripción C" },
    ];
    const { data: createdC, error: es } = await supabase.from("candidates").insert(seed).select();
    if (es) {
      toast($("#voteMsg"), "No hay candidatos y no se pudieron crear (revisa RLS).", true);
    } else {
      localCands = createdC;
    }
  }
  candidates = localCands;

  renderCandidates();
}

function renderCandidates(voteCounts = {}) {
  const list = $("#candidatesList");
  list.innerHTML = "";
  const totalVotes = Object.values(voteCounts).reduce((a,b)=>a+b, 0);

  candidates.forEach(c => {
    const count = voteCounts[c.id] ?? 0;
    const percent = totalVotes > 0 ? Math.round((count * 100) / totalVotes) : 0;

    const item = document.createElement("div");
    item.className = "candidate";
    item.innerHTML = `
      <div>
        <strong>${c.name}</strong>
        <div class="muted">${c.info ?? ""}</div>
        <div class="meter" style="margin-top:8px;"><div style="width:${percent}%"></div></div>
        <div class="muted" style="margin-top:6px;">${count} voto(s) · ${percent}%</div>
      </div>
      <div>
        <button data-cid="${c.id}" class="voteBtn">Votar</button>
      </div>
    `;
    list.appendChild(item);
  });

  $$(".voteBtn").forEach(btn => {
    btn.addEventListener("click", async () => {
      if (!currentUser) {
        toast($("#voteMsg"), "Inicia sesión para votar.", true);
        return;
      }
      await castVote(btn.getAttribute("data-cid"));
    });
  });
}

/* ==========
   VOTAR (upsert por (poll_id, user_id))
   ========== */
async function castVote(candidate_id) {
  if (!currentPoll) return;

  const payload = {
    poll_id: currentPoll.id,
    candidate_id,
    user_id: currentUser.id
  };

  const { data, error } = await supabase
    .from("votes")
    .upsert(payload, { onConflict: "poll_id,user_id" })
    .select()
    .single();

  if (error) {
    toast($("#voteMsg"), "No se pudo registrar el voto: " + error.message, true);
  } else {
    toast($("#voteMsg"), "¡Voto registrado!");
    myVote = data;
    await loadVoteAndResults();
  }
}

/* ==========
   CARGAR MI VOTO + RESULTADOS
   ========== */
async function loadVoteAndResults() {
  if (!currentPoll) return;

  // Mi voto
  if (currentUser) {
    const { data: v, error: ev } = await supabase
      .from("votes")
      .select("*")
      .eq("poll_id", currentPoll.id)
      .eq("user_id", currentUser.id)
      .limit(1);

    if (!ev && v && v.length) {
      myVote = v[0];
      const cand = candidates.find(c => c.id === myVote.candidate_id);
      if (cand) {
        $("#myVotePill").style.display = "inline-flex";
        setText("#myVoteName", cand.name);
      }
    } else {
      $("#myVotePill").style.display = "none";
      myVote = null;
    }
  }

  // Todos los votos (conteo en cliente)
  const { data: allVotes, error: ea } = await supabase
    .from("votes")
    .select("candidate_id")
    .eq("poll_id", currentPoll.id);

  if (ea) {
    toast($("#voteMsg"), "Error cargando resultados: " + ea.message, true);
    return;
  }

  const counts = {};
  (allVotes ?? []).forEach(v => {
    counts[v.candidate_id] = (counts[v.candidate_id] ?? 0) + 1;
  });

  renderCandidates(counts);
}

/* ==========
   REALTIME
   ========== */
let channel = null;
function subscribeRealtime() {
  if (!currentPoll) return;
  if (channel) {
    supabase.removeChannel(channel);
    channel = null;
  }

  channel = supabase
    .channel("realtime-votes")
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: "votes", filter: `poll_id=eq.${currentPoll.id}` },
      async () => {
        await loadVoteAndResults();
      }
    )
    .subscribe();
}

/* ==========
   Sembrar manualmente (si faltan datos y tienes permiso de insert)
   ========== */
$("#seedBtn").addEventListener("click", async () => {
  if (!currentUser) {
    toast($("#voteMsg"), "Inicia sesión para sembrar datos.", true);
    return;
  }
  await ensurePollAndCandidates();
  await loadVoteAndResults();
  toast($("#voteMsg"), "Revisé/sembré datos básicos.");
});

$("#refreshBtn").addEventListener("click", async () => {
  await ensurePollAndCandidates();
  await loadVoteAndResults();
});

/* ==========
   Helpers
   ========== */
function clearUI() {
  setText("#pollTitle", "Encuesta");
  $("#candidatesList").innerHTML = "";
  $("#myVotePill").style.display = "none";
  toast($("#voteMsg"), "Inicia sesión para votar.");
}

/* Start */
await loadSession();
</script>
</body>
</html>
