<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Votación · @unison.mx</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f14; --panel:#101826; --panel-2:#0e1522; --text:#e8edf5; --muted:#9aa5b5;
    --border:rgba(255,255,255,.10); --accent:#7c8cff; --accent2:#29d3a0; --danger:#ff6b6b;
    --ok:#35d0a2;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); background:
     radial-gradient(1200px 600px at 15% -10%, #142037 0%, transparent 40%),
     radial-gradient(900px 500px at 120% 10%, #0f1a2a 0%, transparent 30%),var(--bg);
    min-height:100vh; display:grid; place-items:start center; padding:28px 16px 96px;
  }
  .wrap{width:100%; max-width:980px; display:grid; gap:16px}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
    border:1px solid var(--border); border-radius:16px; padding:18px; backdrop-filter:blur(6px);
    box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  h1{margin:0 0 6px; font-size:28px; letter-spacing:.2px}
  h2{margin:0 0 6px; font-size:20px}
  p{margin:6px 0 0; color:var(--muted)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .right{margin-left:auto}
  .pill{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px;
        border:1px solid var(--border); background:rgba(255,255,255,.06); font-size:12px}
  .sep{height:1px; background:var(--border); margin:12px 0}
  input,button{
    padding:12px; border-radius:12px; border:1px solid var(--border); background:var(--panel-2);
    color:var(--text); outline:none; width:100%;
  }
  input::placeholder{color:#7b8798}
  button{cursor:pointer; transition:transform .1s ease, filter .1s ease}
  button:hover{transform:translateY(-1px); filter:brightness(1.05)}
  .btn{background:linear-gradient(180deg,rgba(124,140,255,.25),rgba(124,140,255,.15)); border-color:rgba(124,140,255,.35)}
  .btn-ghost{background:transparent}
  .btn-ok{background:linear-gradient(180deg,rgba(41,211,160,.25),rgba(41,211,160,.12)); border-color:rgba(41,211,160,.45)}
  .btn-danger{background:linear-gradient(180deg,rgba(255,107,107,.25),rgba(255,107,107,.12)); border-color:rgba(255,107,107,.45)}
  .grid{display:grid; gap:16px; grid-template-columns:1fr}
  @media(min-width:900px){ .grid{grid-template-columns:1.1fr .9fr} }
  .list{display:grid; gap:10px}
  .candidate{display:flex; gap:12px; justify-content:space-between; align-items:center;
             padding:12px; border:1px dashed var(--border); border-radius:12px; background:rgba(255,255,255,.03)}
  .meter{height:10px; background:rgba(255,255,255,.10); border-radius:999px; overflow:hidden}
  .meter>div{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .muted{color:var(--muted); font-size:13px}
  .hint{font-size:12px; color:#a7b0be}
  .msg-ok{color:#a7ffdd} .msg-err{color:#ffc1c1}
  .twocol{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
  label.chk{display:inline-flex; gap:6px; align-items:center; color:var(--muted); font-size:13px}
</style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>Votación institucional</h1>
        <p>Acceso exclusivo con correo <strong>@unison.mx</strong>. Vota y ve resultados en tiempo real.</p>
      </div>
      <div id="authStatus" class="pill">Desconectado</div>
    </div>
  </div>

  <div class="grid">
    <!-- AUTENTICACIÓN -->
    <div class="card">
      <h2>Acceso</h2>
      <p class="muted">Plan B: Email y contraseña (solo <code>@unison.mx</code>)</p>
      <div class="sep"></div>

      <!-- Registro -->
      <form id="signupForm" novalidate>
        <div class="row" style="gap:8px">
          <input id="su_email" type="email" placeholder="Email @unison.mx" required
                 pattern="^[^@\s]+@unison\.mx$"
                 inputmode="email" autocapitalize="none" autocomplete="email" autocorrect="off" spellcheck="false">
          <div class="twocol" style="width:100%">
            <input id="su_pass" type="password" placeholder="Contraseña (mín. 6)" minlength="6" required autocomplete="new-password">
            <label class="chk"><input type="checkbox" onclick="toggle('su_pass')">Mostrar</label>
          </div>
          <button class="btn-ok" type="submit">Crear cuenta</button>
        </div>
        <div id="su_err" class="hint"></div>
      </form>

      <div class="sep"></div>

      <!-- Login -->
      <form id="loginForm" novalidate>
        <div class="row" style="gap:8px">
          <input id="li_email" type="email" placeholder="Email @unison.mx" required
                 pattern="^[^@\s]+@unison\.mx$"
                 inputmode="email" autocapitalize="none" autocomplete="email" autocorrect="off" spellcheck="false">
          <div class="twocol" style="width:100%">
            <input id="li_pass" type="password" placeholder="Contraseña" required autocomplete="current-password">
            <label class="chk"><input type="checkbox" onclick="toggle('li_pass')">Mostrar</label>
          </div>
          <div class="row" style="width:100%">
            <button class="btn" type="submit">Iniciar sesión</button>
            <button class="btn-ghost right" type="button" id="resetBtn">Olvidé mi contraseña</button>
            <button class="btn-ghost" type="button" id="logoutBtn">Cerrar sesión</button>
          </div>
        </div>
        <div id="li_err" class="hint"></div>
      </form>

      <p id="authMsg" class="muted"></p>
    </div>

    <!-- ENCUESTA -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2 id="pollTitle">Encuesta</h2>
        <span id="myVotePill" class="pill" style="display:none;">Mi voto: <strong id="myVoteName"></strong></span>
      </div>
      <p class="muted">Puedes cambiar tu voto cuando quieras.</p>
      <div class="sep"></div>

      <div id="candidatesList" class="list"></div>

      <div class="sep"></div>
      <div class="row">
        <button id="refreshBtn" class="btn-ghost">Actualizar</button>
        <button id="seedBtn" class="btn">Sembrar datos (si faltan)</button>
      </div>
      <p id="voteMsg" class="muted"></p>
    </div>
  </div>

  <div class="card" style="text-align:center">
    <small class="muted">Realtime en <code>public.votes</code> · Políticas RLS activas · Dominio @unison.mx</small>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/* ========= CONFIG ========= */
const SUPABASE_URL = "https://amtcdnaenohempvuwjfz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtdGNkbmFlbm9oZW1wdnV3amZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MTI4ODAsImV4cCI6MjA3MjA4ODg4MH0.u32A7Jd2MjNsrWaW9ENtjfu0tjXkonosHNpYYFhucs4";
const EMAIL_REDIRECT = "https://masteryolo1326-ops.github.io/Test/";
const REQUIRED_DOMAIN = "unison.mx";

/* ========= CLIENTE ========= */
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ========= HELPERS UI ========= */
const $ = (s)=>document.querySelector(s);
function toggle(id){ const i=document.getElementById(id); i.type = (i.type==="password"?"text":"password"); }
function toast(el,msg,ok=false){ el.textContent = msg; el.className = ok?"msg-ok":"msg-err"; }
const isUnison = (email)=>/^[^@\s]+@unison\.mx$/i.test((email||"").trim());

/* ========= ESTADO AUTH ========= */
async function setAuthStatus(){
  const { data:{ user } } = await supabase.auth.getUser();
  $("#authStatus").textContent = user ? `Conectado: ${user.email}` : "Desconectado";
}

/* ========= VALIDACIÓN FORM (evita falsos negativos del pattern) ========= */
function getCleanEmail(inp, errBox){
  const email = inp.value.trim().toLowerCase();
  inp.value = email; // normaliza lo que queda tipeado
  if (!isUnison(email)){
    inp.setCustomValidity("Usa tu correo institucional @unison.mx");
    errBox.textContent = "Usa tu correo institucional @unison.mx";
    return null;
  }
  inp.setCustomValidity("");
  errBox.textContent = "";
  return email;
}

/* ========= SIGNUP ========= */
$("#signupForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = getCleanEmail($("#su_email"), $("#su_err"));
  const pass  = $("#su_pass").value.trim();
  if (!email) return;
  if (pass.length < 6){ $("#su_pass").setCustomValidity("La contraseña debe tener al menos 6 caracteres."); $("#su_err").textContent = "La contraseña debe tener al menos 6 caracteres."; return; }
  $("#su_pass").setCustomValidity("");

  const { error } = await supabase.auth.signUp({
    email, password: pass, options:{ emailRedirectTo: EMAIL_REDIRECT }
  });
  toast($("#authMsg"), error ? `Error: ${error.message}` : "Cuenta creada. Revisa tu correo si está activada la confirmación.", !error);
  await setAuthStatus();
});

/* ========= LOGIN ========= */
$("#loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = getCleanEmail($("#li_email"), $("#li_err"));
  const pass  = $("#li_pass").value.trim();
  if(!email) return;

  const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
  if (error){
    const msg = /invalid login/i.test(error.message) ? "Correo o contraseña incorrectos." :
                /email not confirmed/i.test(error.message) ? "Correo no confirmado. Revisa tu bandeja." :
                error.message;
    toast($("#authMsg"), msg);
  } else {
    toast($("#authMsg"), "Sesión iniciada.", true);
  }
  await setAuthStatus();
});

/* ========= LOGOUT ========= */
$("#logoutBtn").addEventListener("click", async ()=>{
  await supabase.auth.signOut();
  toast($("#authMsg"), "Sesión cerrada.", true);
  await setAuthStatus();
});

/* ========= RESET PASSWORD ========= */
$("#resetBtn").addEventListener("click", async ()=>{
  const email = prompt("Escribe tu correo @unison.mx:");
  if(!email) return;
  if(!isUnison(email)) { alert("Debe ser @unison.mx"); return; }
  const { error } = await supabase.auth.resetPasswordForEmail(email.trim().toLowerCase(), { redirectTo: EMAIL_REDIRECT });
  alert(error ? "Error: "+error.message : "Revisa tu correo para cambiar la contraseña.");
});

/* ========= RECOVERY FLOW ========= */
(async ()=>{
  const hash = new URLSearchParams(location.hash.slice(1));
  if (hash.get("type")==="recovery"){
    const nueva = prompt("Nueva contraseña (mín. 6):");
    if(nueva && nueva.length>=6){
      const { error } = await supabase.auth.updateUser({ password:nueva });
      alert(error ? "Error: "+error.message : "Contraseña actualizada.");
    }
  }
})();

/* ========= ENCUESTA / DATOS ========= */
let currentPoll=null, candidates=[], myVote=null, channel=null;

async function ensurePollAndCandidates(){
  let { data: polls, error:ep } = await supabase.from("polls").select("*").eq("title","Votación de prueba").limit(1);
  if(ep){ toast($("#voteMsg"), "Error encuesta: "+ep.message); return; }
  if(!polls || polls.length===0){
    const { data:created, error:ei } = await supabase.from("polls").insert({ title:"Votación de prueba", is_active:true }).select().limit(1);
    if(ei){ toast($("#voteMsg"), "No se pudo crear encuesta (revisa RLS)."); return; }
    currentPoll = created[0];
  } else currentPoll = polls[0];
  $("#pollTitle").textContent = currentPoll.title;

  const { data:cands, error:ec } = await supabase.from("candidates").select("*").eq("poll_id", currentPoll.id).order("created_at");
  if(ec){ toast($("#voteMsg"), "Error candidatos: "+ec.message); return; }
  let local = cands ?? [];
  if(local.length===0){
    const seed = [
      { poll_id: currentPoll.id, name:"Opción A", info:"Descripción A" },
      { poll_id: currentPoll.id, name:"Opción B", info:"Descripción B" },
      { poll_id: currentPoll.id, name:"Opción C", info:"Descripción C" },
    ];
    const { data:createdC, error:es } = await supabase.from("candidates").insert(seed).select();
    if(es) toast($("#voteMsg"), "No hay candidatos y no se pudieron crear (RLS).");
    else local = createdC;
  }
  candidates = local;
  renderCandidates();
}

function renderCandidates(counts={}){
  const list = $("#candidatesList"); list.innerHTML="";
  const total = Object.values(counts).reduce((a,b)=>a+b,0);
  candidates.forEach(c=>{
    const n = counts[c.id] ?? 0;
    const pct = total>0 ? Math.round(n*100/total) : 0;
    const el = document.createElement("div");
    el.className="candidate";
    el.innerHTML = `
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;gap:8px">
          <strong>${c.name}</strong><span class="muted">${n} voto(s) · ${pct}%</span>
        </div>
        <div class="muted">${c.info??""}</div>
        <div class="meter" style="margin-top:8px"><div style="width:${pct}%"></div></div>
      </div>
      <div><button class="btn" data-cid="${c.id}">Votar</button></div>
    `;
    list.appendChild(el);
  });
  Array.from(document.querySelectorAll(".candidate button")).forEach(b=>{
    b.onclick = async ()=>{
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user){ toast($("#voteMsg"), "Inicia sesión para votar."); return; }
      if(!isUnison(user.email)){ toast($("#voteMsg"), "Solo correos @unison.mx pueden votar."); return; }
      await castVote(b.getAttribute("data-cid"));
    };
  });
}

async function castVote(candidate_id){
  const { data:{ user } } = await supabase.auth.getUser();
  if(!user || !currentPoll) return;
  const payload = { poll_id: currentPoll.id, candidate_id, user_id: user.id };

  const { error:up } = await supabase.from("votes").upsert(payload, { onConflict:"poll_id,user_id" });
  if(up){ toast($("#voteMsg"), "No se pudo registrar el voto: "+up.message); return; }

  const { data:v } = await supabase.from("votes")
       .select("*").eq("poll_id", currentPoll.id).eq("user_id", user.id).maybeSingle();
  myVote = v ?? null;
  toast($("#voteMsg"), "¡Voto registrado!", true);
  await loadVoteAndResults();
}

async function loadVoteAndResults(){
  if(!currentPoll) return;
  const { data:{ user } } = await supabase.auth.getUser();
  if(user){
    const { data:v } = await supabase.from("votes")
      .select("*").eq("poll_id", currentPoll.id).eq("user_id", user.id).maybeSingle();
    if(v){ myVote=v; const cand=candidates.find(x=>x.id===v.candidate_id);
      if(cand){ $("#myVotePill").style.display="inline-flex"; $("#myVoteName").textContent=cand.name; }
    } else { $("#myVotePill").style.display="none"; myVote=null; }
  }
  const { data:all } = await supabase.from("votes").select("candidate_id").eq("poll_id", currentPoll.id);
  const counts={}; (all??[]).forEach(v=>counts[v.candidate_id]=(counts[v.candidate_id]??0)+1);
  renderCandidates(counts);
}

function subscribeRealtime(){
  if(channel) supabase.removeChannel(channel);
  if(!currentPoll) return;
  channel = supabase.channel("rt-votes")
    .on("postgres_changes",
      { event:"*", schema:"public", table:"votes", filter:`poll_id=eq.${currentPoll.id}` },
      async ()=>{ await loadVoteAndResults(); })
    .subscribe();
}

/* Botones */
$("#seedBtn").onclick = async()=>{ const { data:{ user } } = await supabase.auth.getUser();
  if(!user){ toast($("#voteMsg"), "Inicia sesión para sembrar datos."); return; }
  await ensurePollAndCandidates(); await loadVoteAndResults(); toast($("#voteMsg"), "Datos listos.", true);
};
$("#refreshBtn").onclick = async()=>{ await ensurePollAndCandidates(); await loadVoteAndResults(); };

/* Inicio */
(async ()=>{
  await setAuthStatus();
  await ensurePollAndCandidates();
  await loadVoteAndResults();
  subscribeRealtime();
})();
</script>
</body>
</html>
