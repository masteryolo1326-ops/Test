<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Votaciones UNISON — Demo mínima (Registro + Login + Voto)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase SDK v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    fieldset { margin-bottom: 16px; }
    label { display:block; margin:6px 0; }
    input { padding:6px 8px; width: 280px; max-width:100%; }
    button { padding:6px 10px; margin-right:8px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .hidden { display:none; }
    table { border-collapse:collapse; margin-top:12px; }
    td, th { border:1px solid #ccc; padding:4px 8px; }
    #toast { position:fixed; right:12px; top:12px; background:#333; color:#fff; padding:8px 12px; border-radius:6px; display:none; }
    nav button[aria-current="page"] { font-weight:700; text-decoration:underline; }
    .note { background:#fff7cc; border:1px solid #e5d66b; padding:8px 10px; border-radius:6px; margin:8px 0; }
  </style>
</head>
<body>
  <h1>Votaciones UNISON — Demo mínima</h1>
  <div class="note">
    Dominio actual: <b id="dom"></b> · La app fuerza redirección de correo a: <code id="redir"></code>
  </div>
  <div id="toast"></div>

  <nav class="row">
    <button id="tabRegister" aria-current="page">Registrarse</button>
    <button id="tabLogin">Iniciar sesión</button>
  </nav>

  <!-- REGISTER -->
  <fieldset id="boxRegister">
    <legend>Crear cuenta (@unison.mx)</legend>
    <label>Email:
      <input id="r_email" type="email" placeholder="tu@unison.mx" />
    </label>
    <label>Contraseña (min 6):
      <input id="r_pass1" type="password" placeholder="********" />
    </label>
    <label>Confirmar contraseña:
      <input id="r_pass2" type="password" placeholder="********" />
    </label>
    <div class="row">
      <button id="btnRegister">Registrarme</button>
      <button id="btnResend">Reenviar confirmación</button>
    </div>
    <small>Revisa tu correo y confirma la cuenta. Si ya existe, usa “Reenviar confirmación”.</small>
  </fieldset>

  <!-- LOGIN -->
  <fieldset id="boxLogin" class="hidden">
    <legend>Iniciar sesión</legend>
    <label>Email @unison.mx:
      <input id="l_email" type="email" placeholder="tu@unison.mx" />
    </label>
    <label>Contraseña:
      <input id="l_pass" type="password" placeholder="********" />
    </label>
    <div class="row">
      <button id="btnLogin">Entrar</button>
      <button id="btnRecover">Recuperar contraseña</button>
    </div>
  </fieldset>

  <!-- APP -->
  <div id="app" class="hidden">
    <p>Sesión: <span id="uid">—</span> <button id="btnLogout">Salir</button></p>

    <fieldset>
      <legend>Votar (1 por usuario)</legend>
      <div id="candidates"></div>
    </fieldset>

    <fieldset>
      <legend>Resultados (tiempo real)</legend>
      <div>Total votos: <span id="totalVotes">0</span></div>
      <table>
        <thead>
          <tr><th>Candidato</th><th>Votos</th><th>%</th></tr>
        </thead>
        <tbody id="results"></tbody>
      </table>
    </fieldset>
  </div>

<script>
/** ========= CONFIG ========= **/
const SUPABASE_URL = "https://slcewcigqiauczwknedt.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsY2V3Y2lncWlhdWN6d2tuZWR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNzExOTcsImV4cCI6MjA3Njg0NzE5N30.FDsk0JHxIqumSDb8VnHM9SaB8czrTZ5-hVfwb4ekwlA";

/* Fuerza el redirect exacto a tu carpeta /Test/ */
function getEmailRedirect() {
  const base = "https://masteryolo1326-ops.github.io";
  return base + "/Test/"; // <- aquí vive tu index.html
}

/** ========= SUPABASE (singleton) ========= **/
(function ensureSingleton(){
  if (!window.__supa) {
    window.__supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, storageKey: "unison-votaciones-demo" }
    });
  }
  window.supa = window.__supa;
})();

/** ========= STATE & UTILS ========= **/
const state = {
  userId: null,
  hasVoted: false,
  candidates: [
    { id: 1, name: "Planilla 1" },
    { id: 2, name: "Planilla 2" },
    { id: 3, name: "Planilla 3" },
    { id: 4, name: "Planilla 4" }
  ],
  channel: null
};

const $ = (id) => document.getElementById(id);
function toast(msg, ms=2600){ const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', ms); }
function isUnison(email){ return /@unison\.mx$/i.test(String(email||'').trim()); }
function setTab(tab){
  $('boxRegister').classList.toggle('hidden', tab !== 'register');
  $('boxLogin').classList.toggle('hidden', tab !== 'login');
  $('tabRegister').setAttribute('aria-current', tab==='register' ? 'page' : 'false');
  $('tabLogin').setAttribute('aria-current', tab==='login' ? 'page' : 'false');
}
function show(section){
  const inApp = (section === 'app');
  $('app').classList.toggle('hidden', !inApp);
  if (inApp){
    $('boxRegister').classList.add('hidden');
    $('boxLogin').classList.add('hidden');
  } else {
    setTab('register');
  }
}
function renderCandidates(){
  const box = $('candidates');
  box.innerHTML = state.candidates.map(c => 
    `<button data-id="${c.id}" ${state.hasVoted ? 'disabled' : ''}>Votar por ${c.name}</button>`
  ).join(' ');
  box.querySelectorAll('button').forEach(btn=>{
    btn.onclick = () => confirmVote(parseInt(btn.dataset.id,10));
  });
}
function renderResults(rows){
  const total = rows.reduce((a,r)=> a + (r.count||0), 0);
  $('totalVotes').textContent = total;
  const byId = new Map(rows.map(r => [r.candidate_id, r.count||0]));
  $('results').innerHTML = state.candidates.map(c=>{
    const v = byId.get(c.id) || 0;
    const pct = total ? ((v/total)*100).toFixed(1) : "0.0";
    return `<tr><td>${c.name}</td><td>${v}</td><td>${pct}%</td></tr>`;
  }).join('');
}

/** ========= NAV ========= **/
$('tabRegister').onclick = () => setTab('register');
$('tabLogin').onclick = () => setTab('login');

/** ========= AUTH ========= **/
$('btnRegister').onclick = async () => {
  const email = $('r_email').value.trim();
  const p1 = $('r_pass1').value;
  const p2 = $('r_pass2').value;

  if (!isUnison(email)) return toast('Usa tu correo @unison.mx');
  if (!p1 || p1.length < 6) return toast('Contraseña mínima 6 caracteres');
  if (p1 !== p2) return toast('Las contraseñas no coinciden');

  try {
    const { data, error } = await supa.auth.signUp({
      email,
      password: p1,
      options: { emailRedirectTo: getEmailRedirect() }
    });
    if (error) throw error;
    toast('Registro enviado. Revisa tu correo y confirma.');
    setTab('login');
  } catch (e) {
    console.error(e);
    toast(e.message || 'No se pudo registrar');
  }
};

$('btnResend').onclick = async () => {
  const email = $('r_email').value.trim();
  if (!isUnison(email)) return toast('Escribe tu correo @unison.mx primero');
  try {
    const { error } = await supa.auth.resend({
      type: 'signup',
      email,
      options: { emailRedirectTo: getEmailRedirect() }
    });
    if (error) throw error;
    toast('Enviamos un nuevo correo de confirmación (revisa spam).');
  } catch (e) {
    console.error(e);
    toast(e.message || 'No se pudo reenviar');
  }
};

$('btnLogin').onclick = async () => {
  const email = $('l_email').value.trim();
  const password = $('l_pass').value;
  if (!isUnison(email)) return toast('Usa tu correo @unison.mx');
  if (!password) return toast('Escribe tu contraseña');

  try {
    const { error } = await supa.auth.signInWithPassword({ email, password });
    if (error) throw error;
    toast('Sesión iniciada');
    await bootAfterAuth();
  } catch (e) {
    console.error(e);
    toast(e.message || 'Error de autenticación');
  }
};

$('btnRecover').onclick = async () => {
  const email = $('l_email').value.trim();
  if (!isUnison(email)) return toast('Escribe tu correo @unison.mx y vuelve a intentar');
  try {
    const { error } = await supa.auth.resetPasswordForEmail(email, {
      redirectTo: getEmailRedirect()
    });
    if (error) throw error;
    toast('Correo de recuperación enviado');
  } catch (e) {
    console.error(e);
    toast(e.message || 'No se pudo enviar recuperación');
  }
};

$('btnLogout').onclick = async () => {
  await supa.auth.signOut();
  unsubscribe();
  state.hasVoted = false;
  show('loginOrRegister');
  setTab('login');
  $('uid').textContent = '—';
};

async function bootAfterAuth(){
  const { data: { session } } = await supa.auth.getSession();
  if (!session?.user) { show('loginOrRegister'); return; }
  state.userId = session.user.id;
  $('uid').textContent = state.userId;
  show('app');
  await refreshAll();
  subscribe();
}

/* Captura retornos de confirmación/recovery desde el email (hash) */
async function handleAuthFromHash(){
  const params = new URLSearchParams(location.hash.replace(/^#/, ''));
  const type = params.get('type'); // e.g. 'signup', 'recovery'
  if (type) toast(`Estado Auth: ${type}`);
  // Supabase maneja el intercambio de tokens automáticamente al cargar con el hash.
  // Solo arrancamos la app después.
  await bootAfterAuth();
}

supa.auth.onAuthStateChange((_event, _session) => {
  // no-op; bootAfterAuth ya ejecuta la lógica principal
});

/** ========= DATA / RLS ========= **/
async function loadResults(){
  const { data, error } = await supa
    .from('votes')
    .select('candidate_id, count:count(*)')
    .group('candidate_id');
  if (error) {
    console.error('loadResults:', error);
    toast('No se pudieron cargar resultados');
    return;
  }
  renderResults(data || []);
}

async function checkIfUserHasVoted(){
  if (!state.userId) { state.hasVoted = false; return; }
  const { data, error } = await supa
    .from('votes')
    .select('id')
    .eq('user_id', state.userId)
    .maybeSingle();
  if (error && error.code !== 'PGRST116') {
    console.warn('checkIfUserHasVoted:', error);
  }
  state.hasVoted = Boolean(data);
  renderCandidates();
}

async function refreshAll(){
  renderCandidates();
  await loadResults();
  await checkIfUserHasVoted();
}

async function confirmVote(candidateId){
  if (!state.userId) return toast('Debes iniciar sesión');
  if (!confirm(`¿Confirmas tu voto por ${state.candidates.find(c=>c.id===candidateId)?.name}?`)) return;
  try {
    const { error } = await supa.from('votes').insert({
      user_id: state.userId,
      candidate_id: candidateId
    });
    if (error) {
      if (error.code === '23505') {
        state.hasVoted = true;
        renderCandidates();
        return toast('Ya habías votado');
      }
      throw error;
    }
    state.hasVoted = true;
    renderCandidates();
    toast('Voto registrado');
    await loadResults();
  } catch (e) {
    console.error(e);
    toast(e.message || 'No se pudo registrar el voto');
  }
}

/** ========= REALTIME ========= **/
function subscribe(){
  unsubscribe();
  state.channel = supa
    .channel('votes-stream')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'votes' }, async () => {
      await loadResults();
      await checkIfUserHasVoted();
    })
    .subscribe();
}
function unsubscribe(){
  if (state.channel) {
    supa.removeChannel(state.channel);
    state.channel = null;
  }
}

/** ========= BOOT ========= **/
if (location.protocol === 'file:') {
  console.warn('Sirve este archivo con http(s), no file://');
}
document.getElementById('dom').textContent = location.origin + location.pathname;
document.getElementById('redir').textContent = getEmailRedirect();

handleAuthFromHash().catch(console.error);
</script>
