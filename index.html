<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votaci√≥n UNISON ¬∑ Neon UI + Supabase</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --glass1:rgba(255,255,255,.08); --glass2:rgba(255,255,255,.04);
      --text:#EAF0FF; --muted:#9AA6B2; --accent:#7C8CFF; --accent2:#29D3A0; --danger:#FF6B6B;
    }
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -5%, #152548 0%, transparent 40%),
        radial-gradient(900px 500px at 110% 0%, #0F1E39 0%, transparent 35%),
        linear-gradient(135deg,#0f0f23 0%, #1a1a2e 25%, #16213e 50%, #0f3460 100%);
      overflow-x:hidden;
      animation: bgShift 12s ease-in-out infinite alternate;
    }
    @keyframes bgShift{0%{background-position:0 0,0 0,0 0}100%{background-position:20px -20px,-30px 10px,100% 100%}}
    .glass{background:linear-gradient(180deg,var(--glass1),var(--glass2)); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.14)}
    .glow{box-shadow:0 10px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06)}
    .hero-grad{background:linear-gradient(160deg, rgba(124,140,255,.16), rgba(41,211,160,.10));}
    .pill{border:1px solid rgba(255,255,255,.18)}
    .btn{border:1px solid rgba(124,140,255,.45); background:linear-gradient(180deg,rgba(124,140,255,.25),rgba(124,140,255,.12)); color:var(--text)}
    .btn:hover{filter:brightness(1.05); transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-ok{border:1px solid rgba(41,211,160,.55); background:linear-gradient(180deg,rgba(41,211,160,.3),rgba(41,211,160,.12))}
    .card-hover{transition:transform .35s cubic-bezier(.2,.8,.2,1), box-shadow .35s}
    .card-hover:hover{transform:translateY(-6px) scale(1.01); box-shadow:0 25px 50px rgba(0,0,0,.35)}
    .selected{box-shadow:0 0 0 2px rgba(124,140,255,.8), 0 10px 30px rgba(124,140,255,.25)!important}
    .meter{height:10px; background:rgba(255,255,255,.1); border-radius:999px; overflow:hidden}
    .meter > div{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent2))}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="max-w-6xl mx-auto px-5 pt-8 pb-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="glass glow rounded-2xl px-3 py-2"><span class="text-sm tracking-wide opacity-90">UNISON ¬∑ Votaci√≥n</span></div>
        <nav class="hidden md:flex items-center gap-6 text-sm text-slate-300">
          <a href="#info" class="hover:text-white">Info</a>
          <a href="#categorias" class="hover:text-white">Categor√≠as</a>
          <a href="#resultados" class="hover:text-white">Resultados</a>
        </nav>
      </div>
      <div class="flex items-center gap-3">
        <div id="authBadge" class="glass glow rounded-full px-4 py-2 pill text-sm text-slate-200">üîí Desconectado</div>
        <button id="openAuth" class="btn px-4 py-2 rounded-xl text-sm">Acceder</button>
        <button id="logoutBtn" class="btn px-4 py-2 rounded-xl text-sm hidden">Salir</button>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="max-w-6xl mx-auto px-5">
    <div class="grid md:grid-cols-2 gap-6 items-center">
      <div class="glass hero-grad glow rounded-3xl p-8 md:p-10 card-hover">
        <h1 class="text-3xl md:text-4xl font-extrabold leading-tight">Elecciones Estudiantiles</h1>
        <p class="text-slate-300 mt-5">Interfaz neon‚Äëglass conectada a Supabase, con foco en privacidad: en tus tablas solo se usa <code>user_id</code> (no copiamos emails).</p>
        <div class="mt-6 flex gap-3">
          <button class="btn px-5 py-3 rounded-xl" onclick="document.getElementById('categorias').scrollIntoView({behavior:'smooth'})">Comenzar a votar</button>
          <button class="btn-ok px-5 py-3 rounded-xl" onclick="document.getElementById('info').scrollIntoView({behavior:'smooth'})">C√≥mo funciona</button>
        </div>
      </div>
      <figure class="glass glow rounded-3xl overflow-hidden card-hover relative">
        <!-- Inserta tu imagen de referencia aqu√≠ -->
        <img src="assets/landing-ref.jpg" alt="Referencia de dise√±o" class="w-full h-full object-cover max-h-[420px]">
        <figcaption class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-4 text-sm text-slate-200">Layout referencia</figcaption>
      </figure>
    </div>
  </section>

  <!-- INFO -->
  <section id="info" class="max-w-6xl mx-auto px-5 mt-10">
    <div class="grid md:grid-cols-3 gap-5">
      <div class="glass glow rounded-2xl p-6"><h3 class="font-semibold text-lg">Privacidad primero</h3><p class="text-slate-300 mt-1">Solo <em>user_id</em> en la DB. Si alg√∫n d√≠a se requiere email, se manejar√° hash/cifrado fuera del cliente.</p></div>
      <div class="glass glow rounded-2xl p-6"><h3 class="font-semibold text-lg">Voto √∫nico</h3><p class="text-slate-300 mt-1">√çndice √∫nico por encuesta + RLS; puedes cambiar tu voto (upsert) mientras est√© activa.</p></div>
      <div class="glass glow rounded-2xl p-6"><h3 class="font-semibold text-lg">Tiempo real</h3><p class="text-slate-300 mt-1">Actualizaci√≥n autom√°tica v√≠a canales de Supabase.</p></div>
    </div>
  </section>

  <!-- CATEGOR√çAS / CANDIDATOS -->
  <main id="categorias" class="max-w-6xl mx-auto px-5 mt-12">
    <!-- Estado -->
    <div class="glass glow rounded-2xl p-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-emerald-500/90 grid place-items-center">‚úÖ</div>
        <div>
          <p class="font-semibold">Votaci√≥n activa</p>
          <p class="text-slate-300 text-sm">Termina el 15 de diciembre, 18:00</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="refreshBtn" class="btn px-4 py-2 rounded-xl text-sm">Actualizar</button>
        <button id="seedBtn" class="btn-ok px-4 py-2 rounded-xl text-sm hidden">Sembrar demo</button>
      </div>
    </div>

    <!-- Presidente -->
    <section class="mt-8 glass glow rounded-3xl p-7">
      <header class="mb-6">
        <h2 class="text-2xl font-bold">Presidente estudiantil</h2>
        <p class="text-slate-300">Selecciona una opci√≥n.</p>
      </header>
      <div class="grid md:grid-cols-3 gap-6" id="presidentCandidates"></div>
    </section>

    <!-- Vicepresidente -->
    <section class="mt-8 glass glow rounded-3xl p-7">
      <header class="mb-6">
        <h2 class="text-2xl font-bold">Vicepresidente</h2>
        <p class="text-slate-300">Selecciona una opci√≥n.</p>
      </header>
      <div class="grid md:grid-cols-2 gap-6" id="vicepresidentCandidates"></div>
    </section>

    <!-- Resumen -->
    <section class="mt-8 glass glow rounded-3xl p-7">
      <h3 class="text-xl font-semibold">Resumen</h3>
      <div class="mt-4 grid md:grid-cols-2 gap-4 text-sm">
        <div class="glass rounded-xl p-4"><span class="text-slate-300">Presidente:</span> <span id="selectedPresident" class="ml-2 font-semibold">‚Äì</span></div>
        <div class="glass rounded-xl p-4"><span class="text-slate-300">Vicepresidente:</span> <span id="selectedVicePresident" class="ml-2 font-semibold">‚Äì</span></div>
      </div>
      <div class="mt-6"><button id="submitVote" class="btn-ok px-6 py-3 rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed" disabled>Enviar voto</button></div>
    </section>

    <!-- Resultados en vivo -->
    <section id="resultados" class="mt-10 grid md:grid-cols-2 gap-6">
      <div class="glass glow rounded-2xl p-6"><h4 class="font-semibold">Resultados ‚Äî Presidente</h4><div id="resultsPresident" class="space-y-4 mt-4"></div></div>
      <div class="glass glow rounded-2xl p-6"><h4 class="font-semibold">Resultados ‚Äî Vicepresidente</h4><div id="resultsVice" class="space-y-4 mt-4"></div></div>
    </section>
  </main>

  <!-- Modal de √©xito -->
  <div id="successModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="glass glow rounded-2xl p-8 max-w-md mx-4 text-center">
      <div class="w-16 h-16 rounded-full bg-emerald-500/90 grid place-items-center mx-auto mb-4">‚úÖ</div>
      <h3 class="text-2xl font-bold">¬°Voto enviado!</h3>
      <p class="text-slate-300 mt-2">Tu voto fue registrado. En producci√≥n se emite un recibo sin PII.</p>
      <button class="btn mt-5 px-5 py-2 rounded-xl" onclick="document.getElementById('successModal').classList.add('hidden')">Cerrar</button>
    </div>
  </div>

  <!-- Modal Auth -->
  <div id="authModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="glass glow rounded-2xl p-6 w-full max-w-md mx-4">
      <div class="flex items-center justify-between mb-3"><h3 class="text-xl font-bold">Acceso institucional</h3><button class="btn px-3 py-1 rounded-lg text-sm" onclick="toggleAuth(false)">Cerrar</button></div>
      <p class="text-slate-300 text-sm mb-4">Solo correos <code>@unison.mx</code>. No guardamos correos en tus tablas.</p>
      <form id="signupForm" class="space-y-3" novalidate>
        <input id="su_email" class="w-full glass rounded-xl px-3 py-2" type="email" placeholder="Email @unison.mx" required />
        <input id="su_pass" class="w-full glass rounded-xl px-3 py-2" type="password" placeholder="Contrase√±a (m√≠n. 6)" minlength="6" required />
        <button class="btn-ok w-full px-4 py-2 rounded-xl" type="submit">Crear cuenta</button>
        <div id="su_err" class="text-xs text-rose-300"></div>
      </form>
      <div class="my-3 h-px bg-white/20"></div>
      <form id="loginForm" class="space-y-3" novalidate>
        <input id="li_email" class="w-full glass rounded-xl px-3 py-2" type="email" placeholder="Email @unison.mx" required />
        <input id="li_pass" class="w-full glass rounded-xl px-3 py-2" type="password" placeholder="Contrase√±a" required />
        <div class="flex items-center gap-3">
          <button class="btn w-full px-4 py-2 rounded-xl" type="submit">Iniciar sesi√≥n</button>
          <button id="resetBtn" class="btn px-4 py-2 rounded-xl" type="button">Olvid√©</button>
        </div>
        <div id="li_err" class="text-xs text-rose-300"></div>
      </form>
    </div>
  </div>

  <script>
    /* ================== CONFIG ================== */
    const PROJECT_URL  = "https://amtcdnaenohempvuwjfz.supabase.co"; // ‚Üê tu proyecto
    const ANON_KEY     = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtdGNkbmFlbm9oZW1wdnV3amZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MTI4ODAsImV4cCI6MjA3MjA4ODg4MH0.u32A7Jd2MjNsrWaW9ENtjfu0tjXkonosHNpYYFhucs4"; // ‚Üê tu anon key (p√∫blica)
    const REDIRECT_URL = "https://masteryolo1326-ops.github.io/Test/"; // ‚Üê tu redirect
    const DOMAIN_OK    = "unison.mx";

    /* ================== CLIENTE ================== */
    const sb = window.supabase.createClient(PROJECT_URL, ANON_KEY);

    const $ = (s)=>document.querySelector(s);
    function isUnison(email){
      const e = (email||'').trim().toLowerCase();
      return e.includes('@') && !e.includes(' ') && e.endsWith('@'+DOMAIN_OK) && e.split('@')[0].length>0;
    }
    function toast(msg){ const t = document.getElementById('authBadge'); t.textContent = msg; }

    // Estado auth
    async function refreshStatus(){
      const { data:{ user } } = await sb.auth.getUser();
      if(user){
        document.getElementById('authBadge').textContent = '‚úÖ Conectado'; document.getElementById('logoutBtn').classList.remove('hidden');
      } else {
        document.getElementById('authBadge').textContent = 'üîí Desconectado'; document.getElementById('logoutBtn').classList.add('hidden');
      }
      return user;
    }

    function toggleAuth(show){ document.getElementById('authModal').classList[show?'remove':'add']('hidden'); }
    document.getElementById('openAuth').addEventListener('click', ()=> toggleAuth(true));

    // Signup
    document.getElementById('signupForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); const email = document.getElementById('su_email').value.trim().toLowerCase(); const pass = document.getElementById('su_pass').value.trim();
      if(!isUnison(email)){ document.getElementById('su_err').textContent = 'Usa tu correo @unison.mx'; return; }
      if(pass.length<6){ document.getElementById('su_err').textContent = 'Contrase√±a demasiado corta'; return; }
      document.getElementById('su_err').textContent='';
      const { error } = await sb.auth.signUp({ email, password:pass, options:{ emailRedirectTo: REDIRECT_URL }});
      if(error){ document.getElementById('su_err').textContent = error.message; } else { toast('Cuenta creada. Verifica tu correo.'); toggleAuth(false);} 
      await refreshStatus();
    });

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); const email = document.getElementById('li_email').value.trim().toLowerCase(); const pass = document.getElementById('li_pass').value.trim();
      if(!isUnison(email)){ document.getElementById('li_err').textContent = 'Solo @unison.mx'; return; }
      document.getElementById('li_err').textContent='';
      const { error } = await sb.auth.signInWithPassword({ email, password:pass });
      if(error){ document.getElementById('li_err').textContent = error.message; } else { toggleAuth(false); }
      await refreshStatus(); await bootData();
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{ await sb.auth.signOut(); await refreshStatus(); });

    // Reset
    document.getElementById('resetBtn').addEventListener('click', async ()=>{
      const email = prompt('Escribe tu correo @unison.mx:'); if(!email) return; if(!isUnison(email)) return alert('Debe ser @unison.mx');
      const { error } = await sb.auth.resetPasswordForEmail(email.trim().toLowerCase(), { redirectTo: REDIRECT_URL });
      alert(error ? 'Error: '+error.message : 'Revisa tu correo.');
    });

    // Procesa hash de verificaci√≥n/recovery
    (async ()=>{
      const hash = new URLSearchParams(location.hash.slice(1));
      const type = hash.get('type');
      if(type==='recovery'){
        const nueva = prompt('Nueva contrase√±a (m√≠n. 6):');
        if(nueva && nueva.length>=6){ const { error } = await sb.auth.updateUser({ password:nueva }); alert(error?('Error: '+error.message):'Contrase√±a actualizada.'); }
      } else if(type==='signup' || type==='email_change' || hash.get('access_token')){
        history.replaceState(null,'',location.pathname+location.search);
        await refreshStatus(); await bootData();
      }
    })();

    /* ================== DATA (Polls/Candidates/Votes) ================== */
    const POLLS = { president:null, vicepresident:null };
    const CANDS = { president:[],  vicepresident:[] };
    const CHANNELS = [];

    async function ensurePoll(title){
      const { data:rows, error } = await sb.from('polls').select('*').eq('title', title).limit(1);
      if(error) { console.error(error); return null; }
      if(!rows || rows.length===0){
        const { data:created, error:e2 } = await sb.from('polls').insert({ title, is_active:true }).select().limit(1);
        if(e2){ console.warn('No se pudo crear encuesta (RLS):', e2.message); return null; }
        return created[0];
      }
      return rows[0];
    }

    async function ensureCandidates(poll, seed){
      if(!poll) return [];
      const { data:cands, error } = await sb.from('candidates').select('*').eq('poll_id', poll.id).order('created_at', {ascending:true});
      if(error){ console.error(error); return []; }
      let list = cands||[];
      if(list.length===0 && seed && seed.length){
        const prepared = seed.map(s=> ({ poll_id: poll.id, name: s.name, info: s.info }));
        const { data:created, error:e2 } = await sb.from('candidates').insert(prepared).select();
        if(e2){ console.warn('No se pudieron crear candidatos (RLS):', e2.message); } else { list = created; }
      }
      return list;
    }

    function renderCandidates(category){
      const container = document.getElementById(category+"Candidates"); container.innerHTML='';
      const list = CANDS[category];
      list.forEach(c=>{
        const card = document.createElement('article');
        card.className = 'glass glow rounded-2xl p-6 card-hover cursor-pointer';
        const initials = (c.name||'?').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
        card.innerHTML = `
          <div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 to-fuchsia-500 grid place-items-center text-white text-2xl font-bold mb-4">${initials}</div>
          <h3 class="font-semibold text-lg">${c.name}</h3>
          <p class="text-slate-300 text-sm">${c.info||''}</p>`;
        card.addEventListener('click', ()=>{
          document.querySelectorAll('#'+category+'Candidates article').forEach(el=>el.classList.remove('selected'));
          card.classList.add('selected');
          votes[category] = c; updateSummary();
          document.getElementById('submitVote').disabled = !(votes.president && votes.vicepresident);
        });
        container.appendChild(card);
      });
    }

    function renderResults(category, counts){
      const wrap = document.getElementById(category==='president'?'resultsPresident':'resultsVice');
      wrap.innerHTML='';
      const total = Object.values(counts).reduce((a,b)=>a+b,0) || 0;
      CANDS[category].forEach(c=>{
        const n = counts[c.id]||0; const pct = total? Math.round(n*100/total):0;
        const row = document.createElement('div');
        row.innerHTML = `
          <div class="flex justify-between text-sm"><span>${c.name}</span><span>${n} ¬∑ ${pct}%</span></div>
          <div class="meter mt-1"><div style="width:${pct}%"></div></div>`;
        wrap.appendChild(row);
      });
    }

    async function loadResults(){
      await Promise.all(['president','vicepresident'].map(async cat =>{
        const poll = POLLS[cat]; if(!poll) return;
        const { data:all, error } = await sb.from('votes').select('candidate_id').eq('poll_id', poll.id);
        if(error){ console.error(error); return; }
        const counts = {}; (all||[]).forEach(v=> counts[v.candidate_id] = (counts[v.candidate_id]||0)+1);
        renderResults(cat, counts);
      }));
    }

    async function castVote(poll, candidate){
      const { data:{ user } } = await sb.auth.getUser();
      if(!user){ alert('Inicia sesi√≥n para votar'); return false; }
      if(!isUnison(user.email)){ alert('Solo correos @unison.mx'); return false; }
      const payload = { poll_id: poll.id, candidate_id: candidate.id, user_id: user.id };
      const { error } = await sb.from('votes').upsert(payload, { onConflict: 'poll_id,user_id' });
      if(error){ alert('No se pudo guardar el voto: '+error.message); return false; }
      return true;
    }

    function subscribeRealtime(){
      // Limpia canales previos
      while(CHANNELS.length){ const ch = CHANNELS.pop(); sb.removeChannel(ch); }
      ['president','vicepresident'].forEach(cat=>{
        const poll = POLLS[cat]; if(!poll) return;
        const ch = sb.channel('realtime-'+cat)
          .on('postgres_changes', {event:'*', schema:'public', table:'votes', filter:`poll_id=eq.${poll.id}`}, async ()=>{ await loadResults(); })
          .subscribe();
        CHANNELS.push(ch);
      });
    }

    // Votos en memoria UI
    let votes = { president:null, vicepresident:null };
    function updateSummary(){
      document.getElementById('selectedPresident').textContent = votes.president? votes.president.name : '‚Äì';
      document.getElementById('selectedVicePresident').textContent = votes.vicepresident? votes.vicepresident.name : '‚Äì';
    }

    document.getElementById('submitVote').addEventListener('click', async ()=>{
      if(!(votes.president && votes.vicepresident)) return;
      const ok1 = await castVote(POLLS.president, votes.president);
      const ok2 = await castVote(POLLS.vicepresident, votes.vicepresident);
      if(ok1 && ok2){ document.getElementById('successModal').classList.remove('hidden'); await loadResults(); }
    });

    document.getElementById('refreshBtn').addEventListener('click', async ()=>{ await bootData(); });

    // Sembrar demo manual (visible si ?seed=1 en URL)
    (function(){ const u = new URL(location.href); if(u.searchParams.get('seed')==='1') document.getElementById('seedBtn').classList.remove('hidden'); })();
    document.getElementById('seedBtn').addEventListener('click', async ()=>{
      const u = await refreshStatus(); if(!u) return alert('Inicia sesi√≥n');
      await bootData(true); alert('Semilla intentada (revisa RLS si falla).');
    });

    async function bootData(trySeed=false){
      // Define/asegura encuestas
      POLLS.president     = await ensurePoll('Presidente Estudiantil');
      POLLS.vicepresident = await ensurePoll('Vicepresidente');
      // Candidatos (solo si la tabla est√° vac√≠a y RLS lo permite)
      CANDS.president = await ensureCandidates(POLLS.president, trySeed? [
        {name:'Ana Mart√≠nez', info:'Ing. Sistemas ¬∑ 4¬∫'},
        {name:'Carlos L√≥pez', info:'Administraci√≥n ¬∑ 3¬∫'},
        {name:'Sof√≠a Ram√≠rez', info:'Psicolog√≠a ¬∑ 5¬∫'}
      ]:null);
      CANDS.vicepresident = await ensureCandidates(POLLS.vicepresident, trySeed? [
        {name:'Diego Torres', info:'Medicina ¬∑ 2¬∫'},
        {name:'Laura Vega', info:'Derecho ¬∑ 4¬∫'}
      ]:null);
      renderCandidates('president');
      renderCandidates('vicepresident');
      await loadResults();
      subscribeRealtime();
    }

    // Auth state listener
    sb.auth.onAuthStateChange(async ()=>{ await refreshStatus(); });

    // Arranque
    (async ()=>{ await refreshStatus(); await bootData(); })();
  </script>
</body>
</html>
