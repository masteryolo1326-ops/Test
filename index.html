<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat en tiempo real (Supabase)</title>
<style>
  :root { --bg:#0f1220; --panel:#161a2b; --accent:#6c8cff; --text:#eef1ff; --muted:#aab0d6; --border:#232744; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto; background:linear-gradient(160deg,#0b0e1a,#0f1220 40%,#101531); color:var(--text)}
  header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 14px;background:rgba(0,0,0,.25);backdrop-filter:blur(6px);position:sticky;top:0;border-bottom:1px solid var(--border)}
  h1{font-size:16px;margin:0}
  input,button,textarea{background:#0f1330;color:var(--text);border:1px solid #272c50;border-radius:10px;padding:10px 12px;font-size:14px}
  button{cursor:pointer} button.primary{background:var(--accent);border-color:#415fff}
  main{max-width:1000px;margin:14px auto;display:grid;grid-template-columns:280px 1fr;gap:14px;padding:0 12px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .card>.head{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .card>.body{padding:12px;max-height:72vh;overflow:auto}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #messages{display:flex;flex-direction:column;gap:10px}
  .msg{display:grid;grid-template-columns:auto 1fr;gap:8px}
  .avatar{width:34px;height:34px;border-radius:50%;background:#212547;display:grid;place-items:center;font-weight:600}
  .bubble{background:#0f1330;border:1px solid #2b3162;border-radius:12px;padding:10px 12px;white-space:pre-wrap;word-wrap:break-word}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}
  .foot{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end}
  #input{flex:1;min-height:46px;max-height:180px;resize:vertical}
  .muted{color:var(--muted)}
  #err{color:#ff6c6c;margin-top:8px}
  a{color:#9cb3ff}
  @media (max-width:900px){ main{grid-template-columns:1fr} }
</style>
<!-- SDK (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <header>
    <h1>ðŸ’¬ Chat Realtime (Supabase)</h1>
    <div class="row">
      <input id="room" placeholder="Sala (general)" style="width:150px">
      <button id="changeRoom">Entrar</button>
      <input id="name" placeholder="Tu nombre" style="width:160px">
      <button id="saveName">Guardar</button>
      <button id="share" class="primary">Compartir sala</button>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="head"><strong>Info</strong></div>
      <div class="body">
        <div>ðŸ“Œ Sala: <b id="roomLabel">general</b></div>
        <div>ðŸ”— Link: <span id="link" class="muted"></span></div>
        <div id="err"></div>
        <hr style="border:0;border-top:1px solid var(--border);margin:12px 0">
        <div class="muted" style="font-size:13px">
          Enter = enviar â€¢ Shift+Enter = nueva lÃ­nea
        </div>
      </div>
    </section>

    <section class="card" style="display:flex;flex-direction:column">
      <div class="head"><strong>Mensajes</strong></div>
      <div class="body" id="messages"></div>
      <div class="foot">
        <textarea id="input" placeholder="Escribe un mensaje..."></textarea>
        <button id="send" class="primary">Enviar</button>
      </div>
    </section>
  </main>

<script>
/* ========== 1) CREDENCIALES (pon las tuyas) ========== */
const SUPABASE_URL  = "https://amtcdnaenohempvuwjfz.supabase.co"; // <-- pega tu URL
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtdGNkbmFlbm9oZW1wdnV3amZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MTI4ODAsImV4cCI6MjA3MjA4ODg4MH0.u32A7Jd2MjNsrWaW9ENtjfu0tjXkonosHNpYYFhucs4";         // <-- pega tu anon key

/* ========== 2) Setup cliente y utilidades ========== */
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const $ = s => document.querySelector(s);
const els = {
  room: $('#room'), roomLabel: $('#roomLabel'), changeRoom: $('#changeRoom'),
  name: $('#name'), saveName: $('#saveName'), share: $('#share'),
  link: $('#link'), messages: $('#messages'), input: $('#input'), send: $('#send'),
  err: $('#err')
};
const escapeHTML = s => s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const linkify = t => t.replace(/(https?:\/\/\S+)/g,'<a href="$1" target="_blank" rel="noreferrer">$1</a>');

let currentRoom = (new URL(location.href)).hash.replace('#room=','') || 'general';
let channel = null;

function setErr(e){ els.err.textContent = e ? (e.message || e).toString() : ''; if(e) console.error(e); }

function renderMessage(m){
  const li = document.createElement('div'); li.className = 'msg';
  const when = new Date(m.created_at || Date.now());
  const hh = when.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});
  li.innerHTML = `
    <div class="avatar">${escapeHTML((m.name||'?').slice(0,2).toUpperCase())}</div>
    <div>
      <div class="bubble">${linkify(escapeHTML(m.text||''))}</div>
      <div class="meta">${escapeHTML(m.name||'Â¿?')} â€¢ ${hh}</div>
    </div>`;
  els.messages.appendChild(li);
  els.messages.scrollTop = els.messages.scrollHeight;
}

async function loadHistory(room){
  els.messages.innerHTML = '';
  const { data, error } = await client
    .from('messages')
    .select('*')
    .eq('room', room)
    .order('created_at', { ascending: true })
    .limit(300);
  if (error) return setErr(error);
  data.forEach(renderMessage);
}

async function attachRoom(room){
  // cerrar canal anterior
  if (channel) { await client.removeChannel(channel); channel = null; }
  currentRoom = room;
  els.roomLabel.textContent = room;
  els.link.textContent = location.origin + location.pathname + '#room=' + encodeURIComponent(room);
  history.replaceState({}, '', '#room=' + encodeURIComponent(room));

  setErr('');
  await loadHistory(room);

  // suscripciÃ³n realtime por INSERT en la tabla
  channel = client
    .channel('public:messages:' + room)
    .on('postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'messages', filter: 'room=eq.' + room },
        payload => renderMessage(payload.new))
    .subscribe((status) => {
      if (status !== 'SUBSCRIBED') console.log('Realtime status:', status);
    });
}

async function send(){
  const name = (els.name.value.trim() || 'Invitado').slice(0,30);
  const text = (els.input.value || '').trim().slice(0,1000);
  if (!text) return;
  const { error } = await client.from('messages').insert({ room: currentRoom, name, text });
  if (error) return setErr(error);
  els.input.value = '';
}

/* ========== 3) Eventos UI ========== */
els.send.addEventListener('click', send);
els.input.addEventListener('keydown', e=>{
  if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
});
els.saveName.addEventListener('click', ()=>{
  const v = els.name.value.trim(); if (!v) return; localStorage.setItem('chat-name', v);
});
els.changeRoom.addEventListener('click', ()=>{
  const next = (els.room.value || 'general').toLowerCase().replace(/[^\w\-]/g,'-');
  attachRoom(next);
});
els.share.addEventListener('click', async ()=>{
  const url = location.origin + location.pathname + '#room=' + encodeURIComponent(currentRoom);
  try{ await navigator.clipboard.writeText(url); els.share.textContent = 'Â¡Copiado!'; setTimeout(()=>els.share.textContent='Compartir sala',1200); }
  catch{ alert('Enlace: ' + url); }
});

/* ========== 4) Arranque ========== */
els.room.value = currentRoom;
els.name.value = localStorage.getItem('chat-name') || '';
els.link.textContent = location.origin + location.pathname + '#room=' + encodeURIComponent(currentRoom);
attachRoom(currentRoom).catch(setErr);
</script>
</body>
</html>
