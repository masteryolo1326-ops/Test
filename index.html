<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Votación @unison.mx · Supabase</title>

<!-- Fuente moderna -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0B0F16;
    --panel:#0E1522;
    --glass1:rgba(255,255,255,.06);
    --glass2:rgba(255,255,255,.03);
    --text:#EAF0FF;
    --muted:#9AA6B2;
    --border:rgba(255,255,255,.14);
    --accent:#7C8CFF;
    --accent2:#29D3A0;
    --danger:#FF6B6B;
    --ok:#55F2C2;
    --shadow:rgba(0,0,0,.45);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
    background:
      radial-gradient(1200px 600px at 10% -5%, #152548 0%, transparent 40%),
      radial-gradient(900px 500px at 110% 0%, #0F1E39 0%, transparent 35%),
      var(--bg);
    overflow-x:hidden;
  }

  /* Animaciones */
  @keyframes fade-in{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none} }
  @keyframes float{ 0%{transform:translateY(0)} 50%{transform:translateY(-6px)} 100%{transform:translateY(0)} }
  @keyframes pulse{ 0%,100%{box-shadow:0 0 0 0 rgba(124,140,255,.0)} 50%{box-shadow:0 0 0 10px rgba(124,140,255,.08)} }

  .wrap{max-width:1080px; padding:28px 18px 100px; margin:0 auto; animation:fade-in .6s ease both}
  .hero{
    position:relative; border-radius:20px; padding:22px; margin-bottom:16px;
    background:linear-gradient(180deg,var(--glass1),var(--glass2)); border:1px solid var(--border);
    backdrop-filter:blur(8px); box-shadow:0 20px 50px var(--shadow);
  }
  .hero h1{margin:0 0 4px; font-size:28px; letter-spacing:.2px}
  .hero p{margin:4px 0 0; color:var(--muted)}
  .badge{display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px;
         border:1px solid var(--border); background:rgba(255,255,255,.07); font-size:12px}

  .grid{display:grid; gap:18px; grid-template-columns:1fr}
  @media (min-width:980px){ .grid{grid-template-columns:1.1fr .9fr} }

  .card{
    position:relative; border-radius:18px; padding:18px;
    background:linear-gradient(180deg,var(--glass1),var(--glass2));
    border:1px solid var(--border); box-shadow:0 18px 40px var(--shadow);
    backdrop-filter:blur(7px); animation:fade-in .6s .06s ease both;
  }
  h2{margin:0 0 8px}
  p{margin:6px 0 0; color:var(--muted)}
  .sep{height:1px; background:var(--border); margin:14px 0}

  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .right{margin-left:auto}

  input,button{
    padding:12px 14px; border-radius:12px; border:1px solid var(--border);
    background:linear-gradient(180deg,#0F1A2C,#0C1523); color:var(--text);
    outline:none; transition:transform .1s ease, filter .12s ease, border-color .12s ease;
  }
  input:focus{border-color:rgba(124,140,255,.6); filter:brightness(1.05)}
  input::placeholder{color:#7E8CA1}
  .twocol{display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center}
  .hint{font-size:12px; color:#9CA7B6}

  button{cursor:pointer; user-select:none}
  .btn{border-color:rgba(124,140,255,.4); background:linear-gradient(180deg,rgba(124,140,255,.25),rgba(124,140,255,.12))}
  .btn:hover{transform:translateY(-1px); filter:brightness(1.05)}
  .btn:active{transform:translateY(0)}
  .btn-ok{border-color:rgba(41,211,160,.5); background:linear-gradient(180deg,rgba(41,211,160,.25),rgba(41,211,160,.12))}
  .btn-ghost{background:transparent}
  .btn-danger{border-color:rgba(255,107,107,.55); background:linear-gradient(180deg,rgba(255,107,107,.25),rgba(255,107,107,.12))}
  .pulse{animation:pulse 1.8s ease infinite}

  .list{display:grid; gap:12px}
  .candidate{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    padding:12px; border:1px dashed var(--border); border-radius:14px;
    background:rgba(255,255,255,.035); animation:fade-in .4s ease both;
  }
  .meter{height:10px; background:rgba(255,255,255,.1); border-radius:999px; overflow:hidden}
  .meter > div{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent2))}

  .toast{
    position:fixed; left:50%; bottom:26px; transform:translateX(-50%); z-index:9999;
    background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.55)); border:1px solid var(--border);
    color:var(--text); padding:12px 16px; border-radius:12px; backdrop-filter:blur(6px);
    box-shadow:0 14px 30px var(--shadow); min-width:280px; text-align:center; display:none;
  }
  .toast.show{display:block; animation:fade-in .2s ease both}
  .toast.ok{border-color:rgba(41,211,160,.55)}
  .toast.err{border-color:rgba(255,107,107,.55)}
</style>
</head>
<body>

<div class="wrap">
  <div class="hero">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>Votación institucional</h1>
        <p>Acceso exclusivo con correo <strong>@unison.mx</strong>. Vota y mira resultados en tiempo real.</p>
      </div>
      <div id="authStatus" class="badge">Desconectado</div>
    </div>
  </div>

  <div class="grid">
    <!-- AUTENTICACIÓN -->
    <div class="card">
      <h2>Acceso</h2>
      <p class="hint">Plan B: Email y contraseña (solo <code>@unison.mx</code>)</p>
      <div class="sep"></div>

      <!-- Registro -->
      <form id="signupForm" novalidate>
        <div class="row" style="gap:10px">
          <input id="su_email" type="email" placeholder="Email @unison.mx" required
                 pattern="^[^@\s]+@unison\.mx$"
                 inputmode="email" autocapitalize="none" autocomplete="email" autocorrect="off" spellcheck="false" />
          <div class="twocol" style="width:100%">
            <input id="su_pass" type="password" placeholder="Contraseña (mín. 6)" minlength="6" required autocomplete="new-password" />
            <button type="button" class="btn-ghost" id="su_toggle">👁</button>
          </div>
          <button type="submit" class="btn-ok pulse">Crear cuenta</button>
        </div>
        <div id="su_err" class="hint"></div>
      </form>

      <div class="sep"></div>

      <!-- Login -->
      <form id="loginForm" novalidate>
        <div class="row" style="gap:10px">
          <input id="li_email" type="email" placeholder="Email @unison.mx" required
                 pattern="^[^@\s]+@unison\.mx$"
                 inputmode="email" autocapitalize="none" autocomplete="email" autocorrect="off" spellcheck="false" />
          <div class="twocol" style="width:100%">
            <input id="li_pass" type="password" placeholder="Contraseña" required autocomplete="current-password" />
            <button type="button" class="btn-ghost" id="li_toggle">👁</button>
          </div>
          <div class="row" style="width:100%">
            <button type="submit" class="btn">Iniciar sesión</button>
            <button type="button" id="resetBtn" class="btn-ghost right">Olvidé mi contraseña</button>
            <button type="button" id="logoutBtn" class="btn-ghost">Cerrar sesión</button>
          </div>
        </div>
        <div id="li_err" class="hint"></div>
      </form>

      <div class="sep"></div>
      <p id="authMsg" class="hint"></p>
    </div>

    <!-- ENCUESTA -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2 id="pollTitle">Encuesta</h2>
        <span id="myVotePill" class="badge" style="display:none;">Mi voto: <strong id="myVoteName"></strong></span>
      </div>
      <p class="hint">Puedes cambiar tu voto en cualquier momento.</p>
      <div class="sep"></div>

      <div id="candidatesList" class="list"></div>

      <div class="sep"></div>
      <div class="row">
        <button id="refreshBtn" class="btn-ghost">Actualizar</button>
        <button id="seedBtn" class="btn">Sembrar datos (si faltan)</button>
      </div>

      <p id="voteMsg" class="hint"></p>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/* ================== CONFIG ================== */
const PROJECT_URL  = "https://amtcdnaenohempvuwjfz.supabase.co";
const ANON_KEY     = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtdGNkbmFlbm9oZW1wdnV3amZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MTI4ODAsImV4cCI6MjA3MjA4ODg4MH0.u32A7Jd2MjNsrWaW9ENtjfu0tjXkonosHNpYYFhucs4";
const REDIRECT_URL = "https://masteryolo1326-ops.github.io/Test/";
const DOMAIN_OK    = "unison.mx";

/* ================== CLIENTE ================== */
const sb = window.supabase.createClient(PROJECT_URL, ANON_KEY);

/* ================== UTILS UI ================== */
const $ = (s)=>document.querySelector(s);

function showToast(msg, type="ok"){
  const t = $("#toast"); t.textContent = msg;
  t.className = `toast show ${type==="ok" ? "ok":"err"}`;
  clearTimeout(t._hide);
  t._hide = setTimeout(()=> t.className="toast", 2600);
}

function setStatus(text){ $("#authStatus").textContent = text; }

function setPillVote(name){
  if(name){ $("#myVoteName").textContent = name; $("#myVotePill").style.display="inline-flex"; }
  else { $("#myVotePill").style.display="none"; }
}

function normalizeEmail(v){ return (v||"").trim().toLowerCase(); }
function isUnison(email){ return /^[^@\s]+@unison\.mx$/i.test(normalizeEmail(email)); }

/* ================== AUTH ================== */
async function refreshStatus(){
  const { data:{ user } } = await sb.auth.getUser();
  setStatus(user ? `Conectado: ${user.email}` : "Desconectado");
  return user;
}

/* Toggle password */
$("#su_toggle").onclick = ()=>{ const i=$("#su_pass"); i.type = i.type==="password"?"text":"password"; };
$("#li_toggle").onclick = ()=>{ const i=$("#li_pass"); i.type = i.type==="password"?"text":"password"; };

/* Signup */
$("#signupForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = normalizeEmail($("#su_email").value);
  const pass  = $("#su_pass").value.trim();

  if(!isUnison(email)){ $("#su_err").textContent="Usa tu correo institucional @unison.mx"; showToast("Correo debe ser @unison.mx","err"); return; }
  if(pass.length<6){ $("#su_err").textContent="La contraseña debe tener al menos 6 caracteres"; showToast("Contraseña demasiado corta","err"); return; }
  $("#su_err").textContent="";

  const { error } = await sb.auth.signUp({ email, password:pass, options:{ emailRedirectTo: REDIRECT_URL }});
  if(error){ $("#authMsg").textContent = error.message; showToast(error.message,"err"); }
  else { $("#authMsg").textContent = "Cuenta creada. Revisa tu correo si hay confirmación."; showToast("Cuenta creada","ok"); }
  await refreshStatus();
});

/* Login */
$("#loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = normalizeEmail($("#li_email").value);
  const pass  = $("#li_pass").value.trim();

  if(!isUnison(email)){ $("#li_err").textContent="Solo correos @unison.mx"; showToast("Solo @unison.mx","err"); return; }
  $("#li_err").textContent="";

  const { error } = await sb.auth.signInWithPassword({ email, password:pass });
  if(error){ $("#authMsg").textContent = error.message; showToast(error.message,"err"); }
  else { $("#authMsg").textContent = "Sesión iniciada."; showToast("Bienvenido","ok"); }
  await refreshStatus();
  await bootData();
});

/* Logout */
$("#logoutBtn").addEventListener("click", async ()=>{
  await sb.auth.signOut();
  $("#authMsg").textContent = "Sesión cerrada.";
  showToast("Cerraste sesión","ok");
  await refreshStatus();
  renderCandidates(); setPillVote(null);
});

/* Reset password */
$("#resetBtn").addEventListener("click", async ()=>{
  const email = prompt("Escribe tu correo @unison.mx:");
  if(!email) return;
  if(!isUnison(email)){ alert("Debe ser @unison.mx"); return; }
  const { error } = await sb.auth.resetPasswordForEmail(normalizeEmail(email), { redirectTo: REDIRECT_URL });
  alert(error ? "Error: "+error.message : "Revisa tu correo para cambiar la contraseña.");
});

/* Recovery flow */
(async ()=>{
  const hash = new URLSearchParams(location.hash.slice(1));
  if(hash.get("type")==="recovery"){
    const nueva = prompt("Nueva contraseña (mín. 6):");
    if(nueva && nueva.length>=6){
      const { error } = await sb.auth.updateUser({ password:nueva });
      alert(error ? "Error: "+error.message : "Contraseña actualizada. Ya puedes iniciar sesión.");
    }
  }
})();

/* ================== DATA (Polls / Votes) ================== */
let POLL=null, CANDIDATES=[], CHANNEL=null;

async function ensurePoll(){
  // buscar
  let { data: polls, error } = await sb.from("polls").select("*").eq("title","Votación de prueba").limit(1);
  if(error){ $("#voteMsg").textContent="Error encuesta: "+error.message; return; }

  if(!polls || polls.length===0){
    // crear
    const { data: created, error: e2 } = await sb.from("polls").insert({ title:"Votación de prueba", is_active:true }).select().limit(1);
    if(e2){ $("#voteMsg").textContent="No se pudo crear encuesta (revisa RLS)."; return; }
    POLL = created[0];
  } else { POLL = polls[0]; }

  $("#pollTitle").textContent = POLL.title;
}

async function ensureCandidates(){
  const { data:cands, error } = await sb.from("candidates").select("*").eq("poll_id", POLL.id).order("created_at",{ascending:true});
  if(error){ $("#voteMsg").textContent="Error candidatos: "+error.message; return; }

  let local = cands || [];
  if(local.length===0){
    const seed = [
      { poll_id:POLL.id, name:"Opción A", info:"Descripción A" },
      { poll_id:POLL.id, name:"Opción B", info:"Descripción B" },
      { poll_id:POLL.id, name:"Opción C", info:"Descripción C" },
    ];
    const { data: created, error: e2 } = await sb.from("candidates").insert(seed).select();
    if(e2){ $("#voteMsg").textContent="No se pudieron crear candidatos (RLS)."; }
    else { local = created; showToast("Candidatos sembrados","ok"); }
  }
  CANDIDATES = local;
}

function renderCandidates(counts={}){
  const list = $("#candidatesList"); list.innerHTML="";
  const total = Object.values(counts).reduce((a,b)=>a+b,0);

  CANDIDATES.forEach((c, idx)=>{
    const n = counts[c.id] || 0;
    const pct = total>0 ? Math.round(n*100/total) : 0;

    const card = document.createElement("div");
    card.className = "candidate";
    card.style.animationDelay = (idx*0.04)+"s";
    card.innerHTML = `
      <div style="flex:1">
        <div class="row" style="justify-content:space-between">
          <strong>${c.name}</strong>
          <span class="hint">${n} voto(s) · ${pct}%</span>
        </div>
        <div class="hint">${c.info||""}</div>
        <div class="meter" style="margin-top:8px"><div style="width:${pct}%"></div></div>
      </div>
      <div>
        <button class="btn" data-cid="${c.id}">Votar</button>
      </div>
    `;
    list.appendChild(card);
  });

  // Wire buttons
  list.querySelectorAll("button[data-cid]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const { data:{ user } } = await sb.auth.getUser();
      if(!user){ showToast("Inicia sesión para votar","err"); return; }
      if(!isUnison(user.email)){ showToast("Solo correos @unison.mx pueden votar","err"); return; }
      await castVote(btn.getAttribute("data-cid"));
    });
  });
}

async function castVote(candidate_id){
  const { data:{ user } } = await sb.auth.getUser();
  if(!user || !POLL) return;

  const payload = { poll_id:POLL.id, candidate_id, user_id:user.id };

  // upsert
  const { error } = await sb.from("votes").upsert(payload, { onConflict:"poll_id,user_id" });
  if(error){ $("#voteMsg").textContent="No se pudo registrar el voto: "+error.message; showToast("Error guardando voto","err"); return; }

  // leer mi voto y refrescar
  const { data:v } = await sb.from("votes")
     .select("*").eq("poll_id",POLL.id).eq("user_id",user.id).maybeSingle();
  if(v){
    const cand = CANDIDATES.find(x=>x.id===v.candidate_id);
    setPillVote(cand?.name || null);
  }
  showToast("¡Voto registrado!","ok");
  await loadResults();
}

async function loadResults(){
  if(!POLL) return;
  const { data: all, error } = await sb.from("votes").select("candidate_id").eq("poll_id",POLL.id);
  if(error){ $("#voteMsg").textContent="Error resultados: "+error.message; return; }
  const counts = {};
  (all||[]).forEach(v=> counts[v.candidate_id] = (counts[v.candidate_id]||0)+1 );
  renderCandidates(counts);

  // my vote pill
  const { data:{ user } } = await sb.auth.getUser();
  if(user){
    const { data:v } = await sb.from("votes").select("*").eq("poll_id",POLL.id).eq("user_id",user.id).maybeSingle();
    if(v){ const cand=CANDIDATES.find(x=>x.id===v.candidate_id); setPillVote(cand?.name||null); }
    else setPillVote(null);
  } else setPillVote(null);
}

function subscribeRealtime(){
  if(CHANNEL){ sb.removeChannel(CHANNEL); CHANNEL=null; }
  if(!POLL) return;

  CHANNEL = sb.channel("realtime-votes")
    .on("postgres_changes",
      { event:"*", schema:"public", table:"votes", filter:`poll_id=eq.${POLL.id}` },
      async ()=>{ await loadResults(); })
    .subscribe((status)=> console.log("Realtime:", status));
}

/* Botones adicionales */
$("#seedBtn").addEventListener("click", async ()=>{
  const u = await refreshStatus(); if(!u){ showToast("Inicia sesión para sembrar","err"); return; }
  await ensurePoll(); await ensureCandidates(); await loadResults(); subscribeRealtime();
  $("#voteMsg").textContent="Datos verificados/sembrados.";
});
$("#refreshBtn").addEventListener("click", async ()=>{
  await ensurePoll(); await ensureCandidates(); await loadResults();
});

/* ========= BOOT ========= */
async function bootData(){
  await ensurePoll();
  await ensureCandidates();
  await loadResults();
  subscribeRealtime();
}
(async ()=>{
  // estado inicial
  await refreshStatus();
  await bootData();
})();
</script>
</body>
</html>
