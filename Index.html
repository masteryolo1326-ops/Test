<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat en tiempo real</title>
  <style>
    :root { --bg:#0f1220; --panel:#161a2b; --accent:#6c8cff; --text:#eef1ff; --muted:#aab0d6; --danger:#ff6c6c; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
         background:linear-gradient(160deg,#0b0e1a,#0f1220 40%,#101531);color:var(--text)}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:rgba(0,0,0,.25);backdrop-filter:blur(6px);position:sticky;top:0;z-index:2;border-bottom:1px solid #232744}
    h1{font-size:16px;margin:0;opacity:.9}
    .pill{display:flex;gap:8px;align-items:center;background:var(--panel);border:1px solid #232744;border-radius:12px;padding:8px 10px}
    input,select,button,textarea{background:#0f1330;color:var(--text);border:1px solid #272c50;border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
    button{cursor:pointer}
    button.primary{background:var(--accent);border-color:#415fff}
    button.ghost{background:transparent;border-color:#2c315b}
    main{max-width:900px;margin:16px auto;display:grid;grid-template-columns:280px 1fr;gap:16px;padding:0 12px}
    .card{background:var(--panel);border:1px solid #232744;border-radius:14px;overflow:hidden}
    .card > .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #232744}
    .card > .body{padding:12px;max-height:72vh;overflow:auto}
    #messages{display:flex;flex-direction:column;gap:10px}
    .msg{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:flex-start}
    .avatar{width:34px;height:34px;border-radius:50%;background:#212547;display:grid;place-items:center;font-weight:600}
    .bubble{background:#0f1330;border:1px solid #2b3162;border-radius:12px;padding:10px 12px;word-wrap:break-word;white-space:pre-wrap}
    .meta{font-size:12px;color:var(--muted);margin-top:4px}
    .me .bubble{background:#152459;border-color:#3a59ff}
    .me .avatar{background:#2a3272}
    .foot{padding:12px;border-top:1px solid #232744;display:flex;gap:8px;align-items:flex-end}
    #input{flex:1;min-height:46px;max-height:160px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .badge{background:#1e2347;border:1px solid #2c3569;border-radius:999px;padding:6px 10px;font-size:12px}
    a{color:#9cb3ff}
    @media (max-width:900px){ main{grid-template-columns:1fr} }
  </style>
  <!-- Firebase (compat para que funcione con un simple <script>) -->
  <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <h1>ðŸ’¬ Chat en Tiempo Real</h1>
    <div class="row">
      <div class="pill">
        <label class="muted">Sala</label>
        <input id="room" placeholder="general" style="width:140px" />
        <button id="changeRoom" class="ghost">Entrar</button>
      </div>
      <div class="pill">
        <label class="muted">Nombre</label>
        <input id="name" placeholder="Tu nombre" style="width:160px" />
        <button id="saveName" class="ghost">Guardar</button>
      </div>
      <button id="share" class="primary">Compartir sala</button>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="head">
        <strong>Actividad</strong>
        <span class="badge" id="onlineCount">0 en lÃ­nea</span>
      </div>
      <div class="body" id="sideInfo" style="display:flex;flex-direction:column;gap:10px">
        <div>ðŸ“Œ <b>Sala:</b> <span id="roomLabel">general</span></div>
        <div>ðŸ‘€ <b>Escribiendo:</b> <span id="typing" class="muted">â€”</span></div>
        <div>ðŸ”— <b>Enlace de sala:</b> <span id="link" class="muted"></span></div>
        <div style="margin-top:8px" class="muted">
          Enviar: <b>Enter</b> &middot; Nueva lÃ­nea: <b>Shift+Enter</b>
        </div>
      </div>
    </section>

    <section class="card" style="display:flex;flex-direction:column">
      <div class="head"><strong>Mensajes</strong></div>
      <div class="body" id="messages"></div>
      <div class="foot">
        <textarea id="input" placeholder="Escribe un mensaje..."></textarea>
        <button id="send" class="primary">Enviar</button>
      </div>
    </section>
  </main>

  <script>
    // ============ 1) Configura Firebase ============
    // TODO: pega aquÃ­ tu config de Firebase (Project settings > General > "Tus apps")
    // Ejemplo de forma (NO uses estos valores, pega los tuyos):
    /*
    const firebaseConfig = {
      apiKey: "AIzaSy...TU-CLAVE...",
      authDomain: "tu-proyecto.firebaseapp.com",
      databaseURL: "https://tu-proyecto-default-rtdb.firebaseio.com",
      projectId: "tu-proyecto",
      storageBucket: "tu-proyecto.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdefghij"
    };
    */
    const firebaseConfig = { /* <-- Pega aquÃ­ tu config real */ };

    // ============ 2) App base ============
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Utilidades
    const $ = (sel) => document.querySelector(sel);
    const escapeHTML = (s) => s.replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const linkify = (text) => {
      const rx = /(https?:\/\/[^\s]+)/g;
      return escapeHTML(text).replace(rx, '<a href="$1" target="_blank" rel="noreferrer">$1</a>');
    };

    // Estado UI
    const els = {
      room: $('#room'), changeRoom: $('#changeRoom'),
      name: $('#name'), saveName: $('#saveName'),
      share: $('#share'), messages: $('#messages'),
      input: $('#input'), send: $('#send'),
      roomLabel: $('#roomLabel'), typing: $('#typing'),
      onlineCount: $('#onlineCount'), link: $('#link')
    };

    // Preferencias locales
    const defaultRoom = (new URL(location.href)).hash.replace('#room=','') || 'general';
    els.room.value = defaultRoom;
    els.roomLabel.textContent = defaultRoom;
    els.link.innerHTML = `<a>${location.origin + location.pathname}#room=${encodeURIComponent(defaultRoom)}</a>`;
    els.name.value = localStorage.getItem('chat-name') || '';

    // SesiÃ³n anÃ³nima y arranque
    let uid = null;
    let listeners = []; // para .off() al cambiar de sala
    let currentRoom = defaultRoom;
    let typingTimer = null;
    let typingRef = null;
    let presenceRef = null;

    auth.signInAnonymously().catch(console.error);
    auth.onAuthStateChanged(async (user) => {
      if (!user) return;
      uid = user.uid;
      if (!els.name.value) {
        els.name.value = `Invitado-${uid.slice(0,4)}`;
        localStorage.setItem('chat-name', els.name.value);
      }
      attachRoom(currentRoom);
    });

    // Conectar listeners a una sala
    function attachRoom(room){
      detachAll();
      currentRoom = room;
      els.roomLabel.textContent = room;
      els.link.innerHTML = `<a>${location.origin + location.pathname}#room=${encodeURIComponent(room)}</a>`;
      history.replaceState({}, '', `#room=${encodeURIComponent(room)}`);

      // Mensajes (Ãºltimos 100)
      const msgRef = db.ref(`rooms/${room}/messages`).limitToLast(100);
      const onAdd = msgRef.on('child_added', snap => {
        const m = snap.val();
        addMessage(m, m.uid === uid);
      });
      listeners.push({ref: db.ref(`rooms/${room}/messages`), type:'child_added', fn:onAdd});

      // Typing (mostrar lista simple de nombres)
      const typingRoomRef = db.ref(`rooms/${room}/typing`);
      const onTyping = typingRoomRef.on('value', snap => {
        const val = snap.val() || {};
        const names = Object.values(val).map(v=>v.name).filter(Boolean).slice(0,4);
        els.typing.textContent = names.length ? names.join(', ') : 'â€”';
      });
      listeners.push({ref: typingRoomRef, type:'value', fn:onTyping});

      // Presencia (conexiÃ³n por sala)
      if (presenceRef) try{ presenceRef.off(); }catch(e){}
      presenceRef = db.ref(`rooms/${room}/presence/${uid}`);
      const connectedRef = db.ref('.info/connected');
      const onConnected = connectedRef.on('value', snap => {
        if (snap.val() === true) {
          presenceRef.onDisconnect().remove().catch(()=>{});
          presenceRef.set({ name: els.name.value, since: firebase.database.ServerValue.TIMESTAMP });
        }
      });
      listeners.push({ref: connectedRef, type:'value', fn:onConnected});

      const presenceCountRef = db.ref(`rooms/${room}/presence`);
      const onPresence = presenceCountRef.on('value', snap=>{
        const val = snap.val() || {};
        els.onlineCount.textContent = `${Object.keys(val).length} en lÃ­nea`;
      });
      listeners.push({ref: presenceCountRef, type:'value', fn:onPresence});

      // Typing ref del usuario (depende de la sala)
      typingRef = db.ref(`rooms/${room}/typing/${uid}`);
      typingRef.onDisconnect().remove().catch(()=>{});

      // limpiar UI
      els.messages.innerHTML = '';
    }

    function detachAll(){
      for(const l of listeners){
        try { l.ref.off(l.type, l.fn); } catch(e){}
      }
      listeners = [];
    }

    // Render de mensaje
    function addMessage(m, isMe=false){
      const li = document.createElement('div'); li.className = 'msg' + (isMe ? ' me' : '');
      const avatarTxt = (m.name||'?').trim().slice(0,2).toUpperCase();
      const date = m.ts ? new Date(m.ts) : new Date();
      const hh = date.toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'});
      li.innerHTML = `
        <div class="avatar">${escapeHTML(avatarTxt)}</div>
        <div>
          <div class="bubble">${linkify(m.text||'')}</div>
          <div class="meta">${escapeHTML(m.name||'Â¿?')} â€¢ ${hh}</div>
        </div>
      `;
      els.messages.appendChild(li);
      // autoscroll si estÃ¡s cerca del final
      const el = els.messages;
      const nearBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 200;
      if (nearBottom) el.scrollTop = el.scrollHeight;
    }

    // Enviar mensaje
    async function send(){
      const name = els.name.value.trim() || `Invitado-${(uid||'').slice(0,4)}`;
      const text = els.input.value.trim();
      if (!text) return;
      if (!uid) { alert('No hay sesiÃ³n aÃºn. Intenta de nuevo.'); return; }
      const payload = { uid, name, text: text.slice(0,1000), ts: firebase.database.ServerValue.TIMESTAMP };
      await db.ref(`rooms/${currentRoom}/messages`).push(payload);
      els.input.value = '';
      // quitar "typing"
      if (typingRef) typingRef.remove().catch(()=>{});
    }

    // Eventos UI
    els.send.addEventListener('click', send);
    els.input.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); return; }
    });
    els.input.addEventListener('input', ()=>{
      // indicar que estÃ¡ escribiendo
      if (typingRef) typingRef.set({ name: els.name.value || 'Invitado' });
      clearTimeout(typingTimer);
      typingTimer = setTimeout(()=> typingRef && typingRef.remove().catch(()=>{}), 2000);
    });

    els.saveName.addEventListener('click', ()=>{
      const v = els.name.value.trim();
      if (!v) return;
      localStorage.setItem('chat-name', v);
      // actualizar presencia actual
      if (presenceRef) presenceRef.update({ name: v });
      if (typingRef) typingRef.set({ name: v });
    });

    els.changeRoom.addEventListener('click', ()=>{
      const next = (els.room.value || 'general').toLowerCase().replace(/[^\w\-]/g,'-');
      attachRoom(next);
    });

    els.share.addEventListener('click', async ()=>{
      const url = `${location.origin + location.pathname}#room=${encodeURIComponent(currentRoom)}`;
      try {
        await navigator.clipboard.writeText(url);
        els.share.textContent = 'Â¡Enlace copiado!';
        setTimeout(()=> els.share.textContent = 'Compartir sala', 1500);
      } catch {
        alert('Enlace: ' + url);
      }
    });
  </script>
</body>
</html>
